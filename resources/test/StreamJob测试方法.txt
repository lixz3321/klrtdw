1、使用tmp.csv作为表配置文件，内容如下
tb01,d8oracapt.tb01,hdfs://klbigdata:8020/tmp/tb01,id#name#age#pay#city,int#string#int#double#string,id#name,etl_partition,32
tb02,d8oracapt.tb02,hdfs://klbigdata:8020/tmp/tb02,id#name#age#pay#city,int#string#int#double#string,id#name,etl_partition,0
2、逐行将以下json测试数据发送到测试Topic:
#表tb01新增人员 lixz
{"meta_data": [{"name": {"string": "INFA_TABLE_NAME"},"value": {"string": "d8oracapt.tb01"},"type": null},{"name": {"string": "INFA_OP_TYPE"},"value": {"string": "INSERT_EVENT"},"type": null},{"name": {"string": "DTL__CAPXTIMESTAMP"},"value": {"string": "202203291526570000000000"},"type": null}],"columns": {"array": [{"name": {"string": "id"},"value": {"string": "1001"},"isPresent": {"boolean": true},"beforeImage": {"string": "1001"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "name"},"value": {"string": "lixz"},"isPresent": {"boolean": true},"beforeImage": {"string": "lixz"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "age"},"value": {"string": "18"},"isPresent": {"boolean": true},"beforeImage": {"string": "18"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "pay"},"value": {"string": "89.5"},"isPresent": {"boolean": true},"beforeImage": {"string": "89.5"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "city"},"value": {"string": "jinan"},"isPresent": {"boolean": true},"beforeImage": {"string": "jinan"},"isPresentBeforeImage": {"boolean": true}}]}}
#表tb01新增人员 yyy
{"meta_data": [{"name": {"string": "INFA_TABLE_NAME"},"value": {"string": "d8oracapt.tb01"},"type": null},{"name": {"string": "INFA_OP_TYPE"},"value": {"string": "INSERT_EVENT"},"type": null},{"name": {"string": "DTL__CAPXTIMESTAMP"},"value": {"string": "202203291526570000000000"},"type": null}],"columns": {"array": [{"name": {"string": "id"},"value": {"string": "1002"},"isPresent": {"boolean": true},"beforeImage": {"string": "1002"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "name"},"value": {"string": "yyy"},"isPresent": {"boolean": true},"beforeImage": {"string": "yyy"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "age"},"value": {"string": "12"},"isPresent": {"boolean": true},"beforeImage": {"string": "12"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "pay"},"value": {"string": "80.5"},"isPresent": {"boolean": true},"beforeImage": {"string": "80.5"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "city"},"value": {"string": "jinan"},"isPresent": {"boolean": true},"beforeImage": {"string": "jinan"},"isPresentBeforeImage": {"boolean": true}}]}}
#表tb02新增人员 aaa
{"meta_data": [{"name": {"string": "INFA_TABLE_NAME"},"value": {"string": "d8oracapt.tb02"},"type": null},{"name": {"string": "INFA_OP_TYPE"},"value": {"string": "INSERT_EVENT"},"type": null},{"name": {"string": "DTL__CAPXTIMESTAMP"},"value": {"string": "202203291526570000000000"},"type": null}],"columns": {"array": [{"name": {"string": "id"},"value": {"string": "1001"},"isPresent": {"boolean": true},"beforeImage": {"string": "1001"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "name"},"value": {"string": "aaa"},"isPresent": {"boolean": true},"beforeImage": {"string": "aaa"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "age"},"value": {"string": "18"},"isPresent": {"boolean": true},"beforeImage": {"string": "18"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "pay"},"value": {"string": "89.5"},"isPresent": {"boolean": true},"beforeImage": {"string": "89.5"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "city"},"value": {"string": "jinan"},"isPresent": {"boolean": true},"beforeImage": {"string": "jinan"},"isPresentBeforeImage": {"boolean": true}}]}}
#表tb02新增人员 bbb
{"meta_data": [{"name": {"string": "INFA_TABLE_NAME"},"value": {"string": "d8oracapt.tb02"},"type": null},{"name": {"string": "INFA_OP_TYPE"},"value": {"string": "INSERT_EVENT"},"type": null},{"name": {"string": "DTL__CAPXTIMESTAMP"},"value": {"string": "202203291526570000000000"},"type": null}],"columns": {"array": [{"name": {"string": "id"},"value": {"string": "1002"},"isPresent": {"boolean": true},"beforeImage": {"string": "1002"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "name"},"value": {"string": "bbb"},"isPresent": {"boolean": true},"beforeImage": {"string": "bbb"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "age"},"value": {"string": "12"},"isPresent": {"boolean": true},"beforeImage": {"string": "12"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "pay"},"value": {"string": "80.5"},"isPresent": {"boolean": true},"beforeImage": {"string": "80.5"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "city"},"value": {"string": "jinan"},"isPresent": {"boolean": true},"beforeImage": {"string": "jinan"},"isPresentBeforeImage": {"boolean": true}}]}}
3、tb01创建hive外部表查看结果(因为tb02没有设置分区，所以hive无法读取)
use hudi;
CREATE external TABLE tb01(id int,name string,pay double,city string,etl_kafka_topic string,etl_kafka_partition string,etl_kafka_offset string,etl_kafka_timestamp string,etl_cdc_timestamp string) PARTITIONED BY (`etl_partition` string) ROW FORMAT SERDE 'org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe' STORED AS INPUTFORMAT  'org.apache.hudi.hadoop.HoodieParquetInputFormat' OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat' LOCATION '/tmp/tb01';
alter table tb01 add if not exists partition(`etl_partition`='31') location '/tmp/tb01/etl_partition=31';
alter table tb01 add if not exists partition(`etl_partition`='31') location '/tmp/tb01/etl_partition=24';
4、逐行将以下json测试数据发送到测试Topic:
#表tb01人员lixz的city由jinan改为北京
{"meta_data": [{"name": {"string": "INFA_TABLE_NAME"},"value": {"string": "d8oracapt.tb01"},"type": null},{"name": {"string": "INFA_OP_TYPE"},"value": {"string": "UPDATE_EVENT"},"type": null},{"name": {"string": "DTL__CAPXTIMESTAMP"},"value": {"string": "202203291526570000000000"},"type": null}],"columns": {"array": [{"name": {"string": "id"},"value": {"string": "1001"},"isPresent": {"boolean": true},"beforeImage": {"string": "1001"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "name"},"value": {"string": "lixz"},"isPresent": {"boolean": true},"beforeImage": {"string": "lixz"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "age"},"value": {"string": "18"},"isPresent": {"boolean": true},"beforeImage": {"string": "18"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "pay"},"value": {"string": "89.5"},"isPresent": {"boolean": true},"beforeImage": {"string": "89.5"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "city"},"value": {"string": "beijing"},"isPresent": {"boolean": true},"beforeImage": {"string": "jinan"},"isPresentBeforeImage": {"boolean": true}}]}}
#表tb01删除人员 lixz
{"meta_data": [{"name": {"string": "INFA_TABLE_NAME"},"value": {"string": "d8oracapt.tb01"},"type": null},{"name": {"string": "INFA_OP_TYPE"},"value": {"string": "DELETE_EVENT"},"type": null},{"name": {"string": "DTL__CAPXTIMESTAMP"},"value": {"string": "202203291526570000000000"},"type": null}],"columns": {"array": [{"name": {"string": "id"},"value": {"string": "1001"},"isPresent": {"boolean": true},"beforeImage": {"string": "1001"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "name"},"value": {"string": "lixz"},"isPresent": {"boolean": true},"beforeImage": {"string": "lixz"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "age"},"value": {"string": "18"},"isPresent": {"boolean": true},"beforeImage": {"string": "18"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "pay"},"value": {"string": "89.5"},"isPresent": {"boolean": true},"beforeImage": {"string": "89.5"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "city"},"value": {"string": "beijing"},"isPresent": {"boolean": true},"beforeImage": {"string": "jinan"},"isPresentBeforeImage": {"boolean": true}}]}}
#表tb01删除人员 yyy
{"meta_data": [{"name": {"string": "INFA_TABLE_NAME"},"value": {"string": "d8oracapt.tb01"},"type": null},{"name": {"string": "INFA_OP_TYPE"},"value": {"string": "DELETE_EVENT"},"type": null},{"name": {"string": "DTL__CAPXTIMESTAMP"},"value": {"string": "202203291526570000000000"},"type": null}],"columns": {"array": [{"name": {"string": "id"},"value": {"string": "1002"},"isPresent": {"boolean": true},"beforeImage": {"string": "1002"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "name"},"value": {"string": "yyy"},"isPresent": {"boolean": true},"beforeImage": {"string": "yyy"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "age"},"value": {"string": "12"},"isPresent": {"boolean": true},"beforeImage": {"string": "12"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "pay"},"value": {"string": "80.5"},"isPresent": {"boolean": true},"beforeImage": {"string": "80.5"},"isPresentBeforeImage": {"boolean": true}},{"name": {"string": "city"},"value": {"string": "jinan"},"isPresent": {"boolean": true},"beforeImage": {"string": "jinan"},"isPresentBeforeImage": {"boolean": true}}]}}
5、查看hudi表数据变化
6、测试完毕

